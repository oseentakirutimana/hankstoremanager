name: Build Windows Installer (PyInstaller + Inno Setup + SQLCipher)

on:
  workflow_dispatch:
  push:
    branches: ["main"]

env:
  APP_NAME: HankstoreManager
  APP_VERSION: 0.01
  PYTHON_VERSION: '3.11'
  CONDA_ENV_NAME: hankstoremanager

jobs:
  build-windows-installer:
    runs-on: windows-latest
    timeout-minutes: 240

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup runner Python (fallback)
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Show runner info
        shell: pwsh
        run: |
          Write-Host "Runner OS:" (Get-CimInstance Win32_OperatingSystem).Caption
          python --version
          Get-Command python | Select-Object Source | Format-List

      - name: Detect conda
        id: detect_conda
        shell: bash
        run: |
          if command -v conda >/dev/null 2>&1; then
            echo "has_conda=true" >> $GITHUB_OUTPUT
          else
            echo "has_conda=false" >> $GITHUB_OUTPUT
          fi

      - name: Create/update conda env using mamba (best-effort)
        if: steps.detect_conda.outputs.has_conda == 'true'
        id: conda_env
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f environment.yml ]; then
            echo "No environment.yml found; skipping conda env creation"
            echo "env_created=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          ENV_NAME=${CONDA_ENV_NAME}
          # Try to install mamba for faster/more reliable solves
          conda install -n base -c conda-forge mamba -y || echo "mamba install failed; falling back to conda"
          if command -v mamba >/dev/null 2>&1; then
            mamba env update -f environment.yml -n "${ENV_NAME}" --prune
          else
            conda env update -f environment.yml -n "${ENV_NAME}" --prune
          fi
          echo "env_created=true" >> $GITHUB_OUTPUT

      - name: Install MSYS2 + mingw sqlcipher (Windows)
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >-
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-pkg-config
            mingw-w64-x86_64-sqlcipher
          msystem: MINGW64
          path-type: auto

      - name: Ensure mingw64 bin on PATH (Windows)
        shell: pwsh
        run: |
          $mingw = "C:\msys64\mingw64\bin"
          if (Test-Path $mingw) {
            "PATH=$mingw;$env:PATH" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            Write-Host "Added mingw64 to PATH"
          } else {
            Write-Host "mingw64 bin not found; continuing"
          }

      - name: Locate SQLCipher DLL and export SQLCIPHER_DLL_PATH
        shell: pwsh
        run: |
          $dllCandidates = @(
            "C:\msys64\mingw64\bin\libsqlcipher-1.dll",
            "C:\msys64\mingw64\bin\libsqlcipher.dll",
            "$env:USERPROFILE\\miniconda3\\Library\\bin\\libsqlcipher-1.dll",
            "$env:USERPROFILE\\miniconda3\\Library\\bin\\libsqlcipher.dll",
            "C:\ProgramData\Miniconda3\Library\bin\libsqlcipher-1.dll",
            "C:\ProgramData\Miniconda3\Library\bin\libsqlcipher.dll"
          )
          $found = $null
          foreach ($p in $dllCandidates) {
            if (Test-Path $p) { $found = (Resolve-Path $p).Path; break }
          }
          if (-not $found -and (Test-Path "C:\msys64\mingw64\bin")) {
            $search = Get-ChildItem -Path "C:\msys64\mingw64\bin" -Filter "*sqlcipher*.dll" -ErrorAction SilentlyContinue
            if ($search) { $found = $search[0].FullName }
          }
          if ($found) {
            Write-Host "SQLCipher DLL found: $found"
            "SQLCIPHER_DLL_PATH=$found" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          } else {
            Write-Host "SQLCipher DLL not found automatically; PyInstaller may still collect DLL from wheels"
          }

      - name: Install Python build deps (conda-run if env present, else pip)
        shell: bash
        run: |
          set -euo pipefail
          ENV_NAME=${CONDA_ENV_NAME}
          # If conda env exists, install pip deps inside it
          if conda info --envs | awk '{print $1}' | grep -q "^${ENV_NAME}$"; then
            conda run -n "${ENV_NAME}" python -m pip install --upgrade pip setuptools wheel || true
            if [ -f requirements.txt ]; then
              conda run -n "${ENV_NAME}" python -m pip install -r requirements.txt || true
            else
              conda run -n "${ENV_NAME}" python -m pip install pyinstaller cryptography python-dotenv || true
            fi
          else
            python -m pip install --upgrade pip setuptools wheel
            if [ -f requirements.txt ]; then
              pip install -r requirements.txt || true
            else
              pip install pyinstaller cryptography python-dotenv || true
            fi
          fi

      - name: Verify tkinter availability in build Python (use conda env python if present)
        shell: pwsh
        run: |
          $envName = "${{ env.CONDA_ENV_NAME }}"
          $useConda = $false
          try { if ((conda info --envs | awk '{print $1}' | grep -q "^$envName$") -eq $null) { } } catch {}
          if (conda info --envs 2>$null | awk '{print $1}' | grep -q "^$envName$") { $useConda = $true }
          if ($useConda) {
            Write-Host "Testing tkinter inside conda env $envName"
            conda run -n $envName python - <<'PY'
import sys
try:
    import tkinter, tkinter.ttk
    print("TKINTER_OK", getattr(tkinter, "TkVersion", "unknown"))
except Exception as e:
    print("TKINTER_IMPORT_ERROR:", e, file=sys.stderr)
    raise
PY
          } else {
            Write-Host "Testing tkinter using runner Python"
            python - <<'PY'
import sys
try:
    import tkinter, tkinter.ttk
    print("TKINTER_OK", getattr(tkinter, "TkVersion", "unknown"))
except Exception as e:
    print("TKINTER_IMPORT_ERROR:", e, file=sys.stderr)
    raise
PY
          }

      - name: Verify spec files exist
        shell: pwsh
        run: |
          if (-not (Test-Path "./postinstall_writer.spec")) { Write-Error "postinstall_writer.spec missing"; exit 1 }
          if (-not (Test-Path "./hankstoremanager.spec")) { Write-Error "hankstoremanager.spec missing"; exit 1 }
          Write-Host "Spec files found."

      - name: Create install/install_values.txt from secret (production)
        shell: pwsh
        env:
          PROD_FERNET_KEY: ${{ secrets.PROD_FERNET_KEY }}
        run: |
          New-Item -ItemType Directory -Path install -Force | Out-Null
          if ($env:PROD_FERNET_KEY) {
            Write-Host "Creating install\install_values.txt from secret"
            $content = "FACTURATION_OBR_FERNET_KEY=$($env:PROD_FERNET_KEY)`nOBR_USERNAME=`nOBR_PASSWORD=`nOBR_SYSTEM_ID=`n"
            Set-Content -Path install\install_values.txt -Value $content -Encoding UTF8
          } else {
            if (-not (Test-Path "install\install_values.txt")) { "" | Out-File -FilePath install\install_values.txt -Encoding utf8 }
            Write-Host "No PROD_FERNET_KEY secret set; created placeholder install_values.txt"
          }

      - name: Build postinstall_writer (PyInstaller)
        shell: bash
        run: |
          set -euo pipefail
          ENV_NAME=${CONDA_ENV_NAME}
          if conda info --envs | awk '{print $1}' | grep -q "^${ENV_NAME}$"; then
            conda run -n "${ENV_NAME}" pyinstaller --noconfirm --clean postinstall_writer.spec --hidden-import=tkinter --hidden-import=tkinter.ttk
          else
            pyinstaller --noconfirm --clean postinstall_writer.spec --hidden-import=tkinter --hidden-import=tkinter.ttk
          fi

      - name: Build application (PyInstaller)
        shell: bash
        run: |
          set -euo pipefail
          ENV_NAME=${CONDA_ENV_NAME}
          if conda info --envs | awk '{print $1}' | grep -q "^${ENV_NAME}$"; then
            conda run -n "${ENV_NAME}" pyinstaller --noconfirm --clean hankstoremanager.spec --hidden-import=tkinter --hidden-import=tkinter.ttk
          else
            pyinstaller --noconfirm --clean hankstoremanager.spec --hidden-import=tkinter --hidden-import=tkinter.ttk
          fi

      - name: Prepare install/build_artifacts
        shell: pwsh
        run: |
          $build = Join-Path $PWD "install\build_artifacts"
          if (-not (Test-Path $build)) { New-Item -ItemType Directory -Path $build | Out-Null }
          if (Test-Path "dist\postinstall_writer.exe") { Copy-Item "dist\postinstall_writer.exe" (Join-Path $build "postinstall_writer.exe") -Force }
          if (Test-Path "dist\hankstoremanager.exe") { Copy-Item "dist\hankstoremanager.exe" (Join-Path $build "hankstoremanager.exe") -Force }
          Get-ChildItem $build | Select-Object Name,Length

      - name: Install Visual C++ Redistributable (VC++ 2015-2022) via Chocolatey
        shell: pwsh
        run: |
          Write-Host "Installing Visual C++ Redistributable (vcredist-all) via Chocolatey"
          choco install vcredist-all -y
          Write-Host "vcredist-all exit code: $LASTEXITCODE"
          $possible = @(
            "$env:windir\System32\vcruntime140.dll",
            "$env:windir\SysWOW64\vcruntime140.dll"
          )
          foreach ($p in $possible) { if (Test-Path $p) { Write-Host "Found runtime file: $p" } else { Write-Host "Not found: $p" } }

      - name: Install Inno Setup (Chocolatey)
        shell: pwsh
        run: |
          choco install innosetup -y

      - name: Compile Inno Setup Script (ISCC)
        shell: pwsh
        env:
          SQLCIPHER_DLL_PATH: ${{ env.SQLCIPHER_DLL_PATH }}
        run: |
          $iscc = "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe"
          if (-not (Test-Path $iscc)) { $iscc = "ISCC.exe" }
          if (-not (Test-Path $iscc)) { Write-Error "ISCC.exe not found; ensure Inno Setup is installed"; exit 1 }
          Push-Location "install"
          & $iscc "installer.iss"
          $code = $LASTEXITCODE
          Pop-Location
          if ($code -ne 0) { Write-Error "ISCC failed with exit code $code"; exit $code }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: HankstoreManager-Installer
          path: |
            install/Output/HankstoreManager_Setup_v0.01.exe
            install/build_artifacts/*.exe
            dist/*.exe
